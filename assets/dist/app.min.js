/*! Little Alchemy Helper - v2.0 - 2015-04-26
* Copyright (c) 2015; Licensed  */
var App={dataSrc:{},ready:$.Deferred(),elements:{},base:{},names:{},images:{},completedCount:0,lahCookie:null,$library:null,$item:null,release:114,getQueryOption:function(a){a=a.replace(/[\[]/,"\\\\[").replace(/[\]]/,"\\\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?!1:decodeURIComponent(c[1].replace(/\+/g," "))},cleanHeader:function(){this.$library.find("h3").html(this.completedCount?"Remaining Elements":"&nbsp;"),this.$item.hide().filter(":not(.completed)").show()},cleanQueries:function(a){a=a?a:[],-1===$.inArray("completed",a)&&$("#showCompleted").removeClass("btn-primary").addClass("btn-default").find("span").html("show"),-1===$.inArray("filter",a)&&$("#filter").trigger("clear"),-1===$.inArray("search",a)&&$("#search").trigger("clear")},filterMake:function(a){a?(this.cleanQueries(["filter"]),this.$item.show(),this.$item.filter(":data(composition[!*]="+a+")").hide().end(),this.$item.filter(":visible").find("img").trigger("unveil"),this.$library.find("h3").html("Things you can make with: "+a).end().find(".clearQuery").show()):this.cleanHeader()},filterSearch:function(a){a?(this.cleanQueries(["search"]),this.$item.hide(),this.$item.find("h5:contains('"+a.toLowerCase()+"')").parent().show(),this.$item.filter(":visible").find("img").trigger("unveil"),this.$item.filter(":visible").size()?this.$library.find("h3").html("Elements found with: "+a).end().find(".clearQuery").show():this.$library.find("h3").html("Nothing found")):this.cleanHeader()},buildMake:function(a,b){var c=[];return _.each(a,function(a,d){a.composition.indexOf(b)>-1&&c.push(d)}),c.join(", ")},render:function(){var a=[],b={};_.size(this.elements)?_.each(this.elements,function(c,d){b.lahSaved=$.inArray(d,this.lahCookie.getAll())>-1,b.parents=[],_.map(c.parents,function(a){b.parents.push(_.map(a,function(a){return App.names[a]}).join(" + "))}),b.children=_.map(c.children,function(a){return App.names[a]}),a.push('<li id="'+d+'" title="'+c.name+'" class="item thumbnail'+(c.children.length?"":" finalElement")+(b.lahSaved?" completed":"")+'" data-composition="'+(c.parents?b.parents.join(";"):"")+'" data-make="'+b.children.join(", ")+'">'),a.push('<div class="buttons">'),a.push('<a href="#" class="info"><i class="fa fa-eye"></i></a>'),a.push('<a href="#" title="mark as completed" class="adder"></a>'),a.push('<a href="#" title="things you can make with..." class="filter'+(c.children.length?"":" disabled")+'">'+(c.children.length?'<i class="fa fa-external-link-square"></i>':"")+"</a>"),a.push("</div>"),a.push('<div class="image"><img src="data:image/png;base64,'+c.image+'"/></div>'),a.push("<h5>"+c.name+"</h5>"),a.push("</li>")}.bind(this)):a.push('<li class="warning">Something went wrong. Please try again.</li>'),this.$library.find("ul").append(a.join("")),this.$item=this.$library.find(".item"),this.$item.filter(":gt(3)").sortElements(function(a,b){return $(a).prop("title")>$(b).prop("title")?1:-1}),this.$item.tooltip(),this.$item.find("img").unveil(),this.$library.find("h3").html(this.completedCount?"Remaining Elements":"&nbsp;"),$("header h3").html(this.base.length+" elements")}},Cookies=function(){this.name="lah",this.cookie=$.cookie(this.name),this.imported=!1,this.set=function(b){$.cookie(this.name)||$.cookie(this.name,b);var c=$.cookie(this.name).split("|");c.push(b),c=_.uniq(c),$.cookie(this.name,c.join("|")),App.completedCount=c.length,a()},this.getAll=function(){if(!$.cookie(this.name)&&!App.getQueryOption("import"))return[];App.getQueryOption("import")&&!this.imported&&($.cookie(this.name,App.getQueryOption("import").split(",").join("|")),this.imported=!0);var b=$.cookie(this.name).split("|");if(isNaN(parseInt(b[0],10))){var c,d=[];_.each(b,function(a){c=App.names.indexOf(a),d.push(c)}),b.length===d.length&&($.cookie(this.name,d.join("|")),b=d)}return b=$.map(b,function(a){return parseInt(a,10)}),App.completedCount=b.length,a(),b},this.remove=function(b){if(!$.cookie(this.name))return!1;var c=$.cookie(this.name).split("|");$.inArray(b,c)>-1&&c.splice($.inArray(b,c),1),c=_.uniq(c),$.cookie(this.name,c.join("|")),App.completedCount=c.length,a()},this.reset=function(){$.removeCookie(this.name),this.cookie=void 0,App.completedCount=0,a()};var a=function(){var a=App.$library.find("h3").html().indexOf("with")>-1;App.completedCount?($("#completedOptions").show(),a||App.$library.find("h3").html("Remaining Elements")):($("#completedOptions").hide(),a||App.$library.find("h3").html("&nbsp;")),$("#completedCount").find("span").html(App.completedCount)}.bind(this)};$(function(){App.$library=$("#library"),App.lahCookie=new Cookies,App.dataSrc.names=$.ajax({url:"assets/data/base.php?url="+encodeURIComponent("http://littlealchemy.com/offline/resources/en/names."+App.release+".json"),dataType:"json"}),App.dataSrc.base=$.ajax({url:"assets/data/base.php?url="+encodeURIComponent("http://littlealchemy.com/offline/resources/base."+App.release+".json"),dataType:"json"}),App.dataSrc.images=$.ajax({url:"assets/data/base.php?url="+encodeURIComponent("http://littlealchemy.com/offline/resources/images."+App.release+".json"),dataType:"json"}),$.when(App.dataSrc.names,App.dataSrc.base,App.dataSrc.images).done(function(a,b,c){App.names=a[0],App.images=c[0],_.map(b[0],function(a,b){a.platforms||a.hidden||(App.base[b]=a)}),App.ready.resolve()}),App.ready.done(function(){var a=App.base,b=App.names,c=App.images,d=App.elements;$("#elementsCount").text(a.length),_.each(a,function(e,f){d[f]={},d[f].name=b[f],d[f].image=c[f],e.prime||(d[f].parents=[],_.each(e.parents,function(a){d[f].parents.push([a[0],a[1]])})),d[f].children=[],_.each(a,function(a,b){_.each(a.parents,function(a){a.indexOf(+f)>-1&&-1===d[f].children.indexOf(+b)&&d[f].children.push(+b)})})}),App.render()}),"iframe"===App.getQueryOption("type")&&(App.getQueryOption("version")?setTimeout(function(){$("#reloader").is(":visible")&&$("#reloader").fadeOut()},7500):$("#reloader").find("span").html("You are using an old version of the bookmarklet. Please remove it from your bookmarks bar and drag again<h5>"+$("blockquote").find("h5").html()+"</h5>"),$("#reloader").show(),$("header.jumbotron h4").hide(),$("#showCheats").prop("checked",!0).change()),$(document).on("click",".item:not(.completed) .adder",function(a){a.preventDefault();var b=$(this);App.lahCookie.set(b.parents(".item").prop("id")),b.parents(".item").addClass("completed"),$("#showCompleted").hasClass("btn-primary")||b.parents(".item").hide()}).on("click",".item.completed .adder",function(a){a.preventDefault();var b=$(this);App.lahCookie.remove(b.parents(".item").prop("id")),b.parents(".item").removeClass("completed")}).on("click",".item .filter",function(a){a.preventDefault();var b=$(this),c=b.parents(".item").find("h5").html();$("#filter").val(c).change(),App.filterMake(c)}).on("click","blockquote .close",function(a){a.preventDefault();var b=$(this);b.parent()[0].className="",b.parent().slideUp()}),App.$library.find(".clearQuery").on("click",function(a){a.preventDefault(),App.cleanHeader(),App.cleanQueries(),$(this).hide()}),$("#helpBtn").on("click",function(){$("#help").slideToggle()}),$("#filter").on("keydown",function(a){(13===a.keyCode||13===a.which)&&(App.filterMake($(this).val()),$(this).focus())}).clearSearch({callback:App.filterMake.bind(App)}),$("#search").on("keydown",function(a){(13===a.keyCode||13===a.which)&&(App.filterSearch($(this).val()),$(this).focus())}).clearSearch({callback:App.filterSearch.bind(App)}),$("#showCompleted").on("click",function(){var a=$(this);App.$library.find(".clearQuery").hide(),a.hasClass("btn-default")?(App.cleanQueries(["completed"]),a.find("span").html("hide"),App.$item.show(),App.$library.find("h3").html("All Elements")):(a.find("span").html("show"),App.$library.find("h3").html("Remaining Elements"),App.$item.filter(".completed").hide()),a.toggleClass("btn-default").toggleClass("btn-primary")}),$("#resetCompleted").on("click",function(){var a=$(this);a.hasClass("btn-default")?(a.toggleClass("btn-default").toggleClass("btn-danger"),a.find("span").html("Are you sure?"),setTimeout(function(){a.hasClass("btn-default")||a.toggleClass("btn-default").toggleClass("btn-danger").find("span").html("reset completed")},3e3)):a.hasClass("btn-danger")&&(a.toggleClass("btn-default").toggleClass("btn-danger").find("span").html("reset completed"),App.$item.removeClass("completed").show(),App.lahCookie.reset())}),$("#hideFinal").on("click",function(){$(".clearable").trigger("clear"),$("#hideFinal:checked").length?$("div.finalElement").hide():$("div.finalElement").show()}),$(document).on("click",".alert .close",function(){$(this).parent().fadeOut()}),$.dataSelector("!*",function(a,b){return-1===a.indexOf(b.toLowerCase())})});